{"plan_md":"# 0002 — demo-app-workflow\n\n## ADR-style Summary:\n- **Context**: Real end-to-end demo app workflow harness run across TasksGodzilla stack in a dedicated worktree.\n- **Problem Statement**: We need a reproducible plan to prepare the environment, run the demo workflow end-to-end, and capture outputs.\n- **Decision**: Follow a structured multi-step protocol covering setup, environment bootstrap, execution, validation, and closeout.\n- **Alternatives**: (1) Skip full E2E and rely on unit tests only; (2) Run partial components without workers/API; (3) Use synthetic mocks instead of fakeredis/SQLite.\n- **Consequences**: Produces traceable artifacts, clear exit criteria, and validated harness outputs at the cost of extra setup and runtime.\n\n---\n\n## High-Level Plan:\nThis section is a **contract**; do not change during implementation.\n\n- **[Step 0: Prepare and lock plan](./00-setup.md)**: Create and commit protocol artifacts.\n- **[Step 1: Review scope and baseline](./01-review-and-scope.md)**: Read requirements, map the demo flow, and capture baseline repo state.\n- **[Step 2: Bootstrap environment](./02-bootstrap-environment.md)**: Set up Python tooling, dependencies, and env vars for the demo run.\n- **[Step 3: Run demo workflow](./03-run-demo-workflow.md)**: Start services and execute the end-to-end harness; capture outputs and logs.\n- **[Step 4: Validate and stabilize](./04-validate-and-stabilize.md)**: Verify results, run CI checks, and address issues or document gaps.\n- **[Step 5: Finalize](./05-finalize.md)**:\n  * Mark PR Ready\n  * Close out work\n\n---\n\n## Protocol Workflow (How to execute)\nFollow `High-Level Plan` and this cycle for each step.\n\n- **PROJECT_ROOT**: /home/ilya/Documents/dev-pipeline\n- **CWD (worktree)**: /home/ilya/Documents/worktrees/0002-demo-app-workflow\n- **Protocol folder**: /home/ilya/Documents/worktrees/0002-demo-app-workflow/.protocols/0002-demo-app-workflow\n\nAll work happens in the worktree (CWD).\n\n### A. Before a new step (restore context)\n1. Read `Current Step` from `context.md`.\n2. Open the step file (e.g., `01-step-name.md`).\n3. Ensure previous changes are committed.\n\n### B. During the step (execute)\n1. Do the sub-tasks in the step file.\n2. Do **not** change plan files (`plan.md`, `XX-*.md`). They are the contract.\n3. Follow Generic Principles below.\n\n### C. After the step (verify & fix)\n1. Run checks: `typecheck`, `lint`, `test`. Fix until green.\n2. Add a `log.md` entry describing what and why (include commit ID).\n3. Rewrite `context.md` for the next step.\n4. Verify `main` has no stray files from our branch. Commit with `type(scope): subject [protocol-0002/YY]`. Push.\n5. Report to the user in the format:\n<report_format>\n(Protocol, step):\n\n**Done**: what/where/why (also in Log).\n\n**Checks**: which ran (lint/typecheck/test), pass/fail, why.\n\n**Git**: PR link; current branch; commit message; push status; main-branch cleanliness check.\n\n**Working directory**: absolute CWD path.\n\n**Protocol status**: where we are and what’s next.\n</report_format>\n\n---\n\n## Generic Principles (MUST follow, shared)\n- Balance & simplicity; avoid overengineering.\n- No legacy; greenfield decisions allowed.\n- Respect coding standards/linters/formatters/JSDoc.\n- Keep docs current (Memory Bank), atomic.\n- Quality tests: positive/negative/boundaries; reuse helpers.\n- Detail & decomposition: plans executable without this chat.\n\n---\n\n## Reference Materials\n- AGENTS and repository guidelines in `AGENTS.md`.\n- Build/test scripts under `scripts/ci/*.sh` (bootstrap, lint, typecheck, test, build).\n- Runtime entrypoints: `scripts/api_server.py`, `scripts/rq_worker.py`; config via `tasksgodzilla.config.load_config`.\n- Project docs in `docs/`, prompts in `prompts/`, schemas in `schemas/`, migrations in `alembic/`.","context_md":"- **Current Step**: 0\n- **Status**: Not Started\n- **Last Action Summary**: \"Plan generated, awaiting approval.\"\n- **Next Action**: \"Start Step 0 (see `00-setup.md`).\"\n- **Git**: \"Branch 0002-demo-app-workflow created, empty.\"\n- **PROJECT_ROOT**: \"/home/ilya/Documents/dev-pipeline\"\n- **CWD**: \"/home/ilya/Documents/worktrees/0002-demo-app-workflow\"","log_md":"# Work Log: 0002 — demo-app-workflow\n\nThis is an append-only log:\n\n{add entries about actions, decisions, gotchas, solved issues}\n","step_files":[{"filename":"00-setup.md","content":"# Step 0: Prepare and lock the plan\n\n## Briefing\nThis is a technical step: commit plan files, publish the branch, and open a PR/MR. These actions must be done before reporting to the user.\n\n## Sub-tasks\n1. **Create and save** all protocol artifacts (`plan.md`, `context.md`, `log.md`, `00-setup.md`, and all future step files) in `.protocols/0002-demo-app-workflow/`.\n2. **Make the first commit** with these files to branch `0002-demo-app-workflow`.\n3. **Create Draft PR/MR** on GitHub or GitLab.\n4. **Update `context.md`**: set `Current Step` to `1`, `Status` to `In Progress`, update `Next Action` for Step 1.\n5. **Save** the updated `context.md` **without committing** (it will be in the next step’s commit).\n\n## Workflow\n1. Execute sub-tasks.\n2. Verify: run `lint`, `typecheck`, `test` (scope as needed). Fix failures.\n3. Fix/record:\n   - Add to `log.md` what/why (non-obvious decisions).\n   - Update `context.md`: increment `Current Step`, set `Next Action`.\n   - Check `main` for stray files from our branch.\n4. Commit: `git add .` then `git commit -m \"feat(scope): subject [protocol-0002/00]\"`. Push.\n5. Report to user using the step report format above.\n"},{"filename":"01-review-and-scope.md","content":"# Step 01: Review scope and baseline\n\n## Briefing\n- **Goal:** Confirm objectives, identify the demo workflow path, and capture current repo/branch state before execution.\n- **Key files:**\n  - `README.md`, `docs/`\n  - `tasksgodzilla/` (jobs, orchestrator, API, worker)\n  - `scripts/` (protocol pipeline, CI helpers)\n- **Additional info:** Paths are relative to `/home/ilya/Documents/dev-pipeline`. Keep notes in `log.md` about assumptions and selected demo scenario.\n\n## Sub-tasks\n1. Read `AGENTS.md`, `README.md`, and relevant docs/prompts to understand the demo workflow intent and required components.\n2. Map the demo job or workflow to run (e.g., job definitions in `tasksgodzilla/jobs/` or examples in `tests/`), noting inputs/outputs and required env vars.\n3. Check current branch and worktree status (`git status`), noting any existing changes to preserve.\n4. Identify dependencies, services, or data fixtures needed for the run (fakeredis, SQLite DB path, sample payloads).\n5. Record findings and chosen workflow scenario in `log.md`; outline expected success criteria and artifacts to collect.\n\n## Workflow\n1. Execute sub-tasks.\n2. Verify: run `lint`, `typecheck`, `test` (scope as needed). Fix failures.\n3. Fix/record:\n   - Add to `log.md` what/why (non-obvious decisions).\n   - Update `context.md`: increment `Current Step`, set `Next Action`.\n   - Check `main` for stray files from our branch.\n4. Commit: `git add .` then `git commit -m \"feat(scope): subject [protocol-0002/01]\"`. Push.\n5. Report to user using the step report format above.\n"},{"filename":"02-bootstrap-environment.md","content":"# Step 02: Bootstrap environment\n\n## Briefing\n- **Goal:** Prepare a clean Python 3.12 environment with all dependencies and configuration needed for the demo workflow.\n- **Key files:**\n  - `scripts/ci/bootstrap.sh`\n  - `requirements-orchestrator.txt`, `requirements.txt` (if applicable)\n  - `.env` or env var exports for `TASKSGODZILLA_*`\n- **Additional info:** Default local settings use `TASKSGODZILLA_DB_PATH=/tmp/tasksgodzilla-ci.sqlite` and `TASKSGODZILLA_REDIS_URL=fakeredis://`. Prefer the provided scripts over manual installs.\n\n## Sub-tasks\n1. Ensure Python 3.12 is available; create or refresh `.venv` inside the worktree.\n2. Run `scripts/ci/bootstrap.sh` to install dependencies and tooling (ruff).\n3. Export or document required environment variables for the demo run (DB path, Redis URL, API token if needed) in the shell profile or a local `.env` file not committed.\n4. Smoke-check installs: run `scripts/ci/typecheck.sh` or a minimal import test (`python - <<'PY' ...`) to confirm the environment loads `tasksgodzilla` modules.\n5. Update `log.md` with environment setup details, versions, and any deviations.\n\n## Workflow\n1. Execute sub-tasks.\n2. Verify: run `lint`, `typecheck`, `test` (scope as needed). Fix failures.\n3. Fix/record:\n   - Add to `log.md` what/why (non-obvious decisions).\n   - Update `context.md`: increment `Current Step`, set `Next Action`.\n   - Check `main` for stray files from our branch.\n4. Commit: `git add .` then `git commit -m \"feat(scope): subject [protocol-0002/02]\"`. Push.\n5. Report to user using the step report format above.\n"},{"filename":"03-run-demo-workflow.md","content":"# Step 03: Run demo workflow\n\n## Briefing\n- **Goal:** Execute the real end-to-end demo app workflow using TasksGodzilla components and capture outputs.\n- **Key files:**\n  - `scripts/api_server.py`\n  - `scripts/rq_worker.py`\n  - `tasksgodzilla/` job definitions and configs\n  - `scripts/ci/test.sh` (for smoke or integration coverage)\n- **Additional info:** Use fakeredis and SQLite defaults unless the chosen workflow requires different backends. Capture run IDs, logs, and any generated artifacts.\n\n## Sub-tasks\n1. Define the exact demo scenario to execute (e.g., a sample job or protocol from docs/tests); document expected inputs/outputs.\n2. Ensure required env vars are exported for the run (DB path, Redis URL, API token if needed).\n3. Start the API server in one terminal: `.venv/bin/python scripts/api_server.py --host 0.0.0.0 --port 8010` (adjust as needed).\n4. Start the worker in another terminal: `.venv/bin/python scripts/rq_worker.py`.\n5. Trigger the demo workflow via the appropriate interface (CLI in `scripts/`, HTTP request to the API, or test helper), providing sample payloads and noting identifiers.\n6. Monitor logs/console output for the API and worker; capture success indicators, errors, timings, and generated artifacts.\n7. If available, run `scripts/ci/test.sh` or targeted pytest cases to validate the same path or to confirm no regressions introduced by the run.\n8. Record outcomes, run IDs, payloads, and locations of artifacts in `log.md`.\n\n## Workflow\n1. Execute sub-tasks.\n2. Verify: run `lint`, `typecheck`, `test` (scope as needed). Fix failures.\n3. Fix/record:\n   - Add to `log.md` what/why (non-obvious decisions).\n   - Update `context.md`: increment `Current Step`, set `Next Action`.\n   - Check `main` for stray files from our branch.\n4. Commit: `git add .` then `git commit -m \"feat(scope): subject [protocol-0002/03]\"`. Push.\n5. Report to user using the step report format above.\n"},{"filename":"04-validate-and-stabilize.md","content":"# Step 04: Validate and stabilize\n\n## Briefing\n- **Goal:** Confirm the demo workflow results, run CI checks, and address issues or document gaps.\n- **Key files:**\n  - `log.md` entries from the run\n  - CI scripts: `scripts/ci/lint.sh`, `scripts/ci/typecheck.sh`, `scripts/ci/test.sh`\n  - Any modified source files under `tasksgodzilla/` or scripts\n- **Additional info:** Capture evidence (screens, logs, artifacts) showing success or failures. Prefer fixes where feasible; otherwise, document follow-ups.\n\n## Sub-tasks\n1. Analyze outputs from the demo run: verify expected artifacts, database entries, or external side effects; note any deviations.\n2. Run CI checks: `scripts/ci/lint.sh`, `scripts/ci/typecheck.sh`, and `scripts/ci/test.sh`; capture results and address failures.\n3. If issues were found, implement minimal fixes or document blockers with reproduction steps and logs.\n4. Update documentation or configs if behavior or instructions changed (e.g., README snippets, sample env settings).\n5. Summarize validation results and remaining risks in `log.md`.\n\n## Workflow\n1. Execute sub-tasks.\n2. Verify: run `lint`, `typecheck`, `test` (scope as needed). Fix failures.\n3. Fix/record:\n   - Add to `log.md` what/why (non-obvious decisions).\n   - Update `context.md`: increment `Current Step`, set `Next Action`.\n   - Check `main` for stray files from our branch.\n4. Commit: `git add .` then `git commit -m \"feat(scope): subject [protocol-0002/04]\"`. Push.\n5. Report to user using the step report format above.\n"},{"filename":"05-finalize.md","content":"# Step 05: Finalize\n\n## Briefing\n- **Goal:** Close out the protocol with clear status, documentation, and PR readiness.\n- **Key files:**\n  - `context.md`, `log.md`\n  - PR description and metadata\n- **Additional info:** Ensure all instructions from the workflow report format are satisfied; no untracked files.\n\n## Sub-tasks\n1. Ensure `log.md` and `context.md` reflect final state, decisions, and next steps (if any).\n2. Verify working tree is clean and branch is pushed; update PR from Draft to Ready for Review.\n3. Re-run any lightweight checks if needed to ensure freshness (e.g., quick smoke or targeted tests).\n4. Prepare final user report summarizing accomplishments, checks, git status, and protocol state.\n5. Tag or note any follow-up tasks and owners if unresolved items remain.\n\n## Workflow\n1. Execute sub-tasks.\n2. Verify: run `lint`, `typecheck`, `test` (scope as needed). Fix failures.\n3. Fix/record:\n   - Add to `log.md` what/why (non-obvious decisions).\n   - Update `context.md`: increment `Current Step`, set `Next Action`.\n   - Check `main` for stray files from our branch.\n4. Commit: `git add .` then `git commit -m \"feat(scope): subject [protocol-0002/05]\"`. Push.\n5. Report to user using the step report format above.\n"}]}